<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8" />
  <title>Portal Upgrade Paket Belajar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: Arial; background:#f5f5f5; padding:20px; max-width:700px; margin:auto; }
    .card { background:white; padding:16px; border-radius:12px; margin-bottom:16px; }
    select, input, textarea, button { width:100%; padding:10px; margin-top:8px; }
    button { background:#2563eb; color:white; border:none; border-radius:8px; }
    .slot { border:1px solid #eee; padding:10px; border-radius:8px; margin-top:8px; }
  </style>

</head>

<body>

<h2>Portal Upgrade Paket Belajar</h2>

<div class="card">
  <b>Pilih kelas</b>
  <select id="kelas">
    <option value="">Pilih kelas</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
    <option value="11">11</option>
  </select>
</div>

<div id="mapelSection" class="card" style="display:none">
  <b>Pilih mapel tambahan</b>
  <select id="mapel">
    <option value="">Pilih mapel</option>
    <option value="Fisika">Fisika</option>
    <option value="Kimia">Kimia</option>
  </select>
</div>

<div id="priceBox" class="card" style="display:none"></div>

<div id="materiBox" class="card" style="display:none"></div>
  
<div id="schedule" class="card" style="display:none"></div>

<div id="formSection" class="card" style="display:none">
  <input id="nama" placeholder="Nama murid"/>
  <input id="nomor" placeholder="Nomor murid"/>
  <textarea id="preferensi" placeholder="Preferensi jadwal"></textarea>
  <div style="font-size:13px; color:#555; margin-top:10px; line-height:1.5">
  Jumlah sesi mata pelajaran tambahan akan menyesuaikan hingga tanggal jatuh tempo.<br>
  Pada bulan berikutnya, pembayaran seluruh mata pelajaran akan digabung dan dibayarkan sesuai tanggal jatuh tempo.
</div>
  <button onclick="submitForm()">Kirim Permintaan Upgrade</button>
</div>

<script>

let kelas = "";
let mapel = "";

document.getElementById("kelas").onchange = function() {
  kelas = this.value;

  const priceBox = document.getElementById("priceBox");

  if(["7","8","9","10"].includes(kelas)){
    priceBox.style.display = "block";
    priceBox.innerHTML = "Biaya upgrade IPA: <b>Rp 49.000 / bulan</b>";
  }
  else if(kelas === "11"){
    priceBox.style.display = "block";
    priceBox.innerHTML = `
      Biaya upgrade:<br>
      • Fisika: <b>Rp 49.000</b><br>
      • Kimia: <b>Rp 49.000</b><br>
      • Fisika + Kimia: <b>Rp 79.000</b>
    `;
  } else {
    priceBox.style.display = "none";
  }
  
  if(["7","8","9","10"].includes(kelas)){
    mapel = "IPA";
    document.getElementById("mapelSection").style.display="none";
    loadSchedule();
    loadMateri();
  } else {
    mapel = "";
    document.getElementById("mapelSection").style.display="block";
  }
};

document.getElementById("mapel").onchange = function(){
  mapel = this.value;
  loadSchedule();
  loadMateri();
}

async function loadSchedule(){
  document.getElementById("schedule").style.display="block";
  document.getElementById("schedule").innerHTML="Memuat jadwal...";
  document.getElementById("formSection").style.display="block";

  try{
    let subject = encodeURIComponent(mapel);

    let res = await fetch(`https://script.google.com/macros/s/AKfycbyNHLybS79wm2VckkUPXDWL1Ped3EZCvyUXKlFLP_a5GRBU6edTFKSRcdipR8rWzTi1YA/exec?kelas=${kelas}&subject=${encodeURIComponent(mapel)}`);

    let data = await res.json();

    if(!data.length){
      document.getElementById("schedule").innerHTML="Slot penuh. Silakan tulis preferensi jadwal.";
      return;
    }

    document.getElementById("schedule").innerHTML = `
      <b>Pilihan jadwal tersedia</b><br><br>
      ${data.slice(0,6).map(s =>
        `<div class='slot'><b>${s.days} • ${s.time}</b><br>${s.teacher}<br>Sisa kursi: ${s.seatsLeft}</div>`
      ).join("")}
    `;

  }catch{
    document.getElementById("schedule").innerHTML="Gagal memuat jadwal.";
  }
}

async function loadMateri(){
  const box = document.getElementById("materiBox");

  box.style.display = "block";
  box.innerHTML = "Memuat materi...";

  const res = await fetch(
  `https://script.google.com/macros/s/AKfycbyNHLybS79wm2VckkUPXDWL1Ped3EZCvyUXKlFLP_a5GRBU6edTFKSRcdipR8rWzTi1YA/exec?type=materi&kelas=${kelas}&mapel=${encodeURIComponent(mapel)}`
  );

  const data = await res.json();

  if(!data.length){
    box.style.display="none";
    return;
  }

  box.style.display="block";
  box.innerHTML = `
    <b>Materi pembelajaran</b><br><br>
    ${data.map(m => {
      const lines = m.materi
        .split(/\r?\n/)        
        .map(l => l.trim())
        .filter(l => l.length);

      return `
        <div class="slot">
          ${lines.map(l => `• ${l}`).join("<br>")}
        </div>
      `;
    }).join("")}
  `;
}
  
async function submitForm(){
  const formData = new FormData();

  formData.append("entry.875605922", document.getElementById("nama").value);
  formData.append("entry.1265930966", document.getElementById("nomor").value);
  formData.append("entry.2132303950", kelas);
  formData.append("entry.1880586050", mapel);
  formData.append("entry.1375621433", document.getElementById("preferensi").value);

  if(kelas === "11"){
    formData.append("entry.1564078808", mapel);
  }

  await fetch("https://docs.google.com/forms/d/e/1FAIpQLSdeu8mdcvTxVzQXm3A2mla9hhO-i4T3erD-dFJhYo_r1qdbhQ/formResponse", {
    method:"POST",
    mode:"no-cors",
    body:formData
  });

  alert("Permintaan terkirim. Kakak Siaga akan menghubungi segera.");
}
  
</script>

</body>
</html>
